<!doctype html>
<html>
  <body style="font-family:system-ui;padding:16px;max-width:600px">
    <h3>AI Project Saver</h3>
    <label>Webhook URL<br><input id="url" style="width:100%"></label><br><br>
    <label>Secret<br><input id="secret" style="width:100%"></label><br><br>
    <button id="save">Save</button>
    <button id="test" style="margin-left:8px;">Send Test</button>

    <script>
      chrome.storage.sync.get(['webhook','secret'], ({webhook, secret}) => {
        if (webhook) document.getElementById('url').value = webhook;
        if (secret) document.getElementById('secret').value = secret;
      });

      document.getElementById('save').onclick = () => {
        chrome.storage.sync.set({
          webhook: document.getElementById('url').value.trim(),
          secret: document.getElementById('secret').value.trim()
        }, () => alert('Saved'));
      };

      async function sign(body, secret) {
        const enc = new TextEncoder().encode(JSON.stringify(body));
        const key = await crypto.subtle.importKey(
          'raw', new TextEncoder().encode(secret),
          {name:'HMAC', hash:'SHA-256'}, false, ['sign']
        );
        const sig = await crypto.subtle.sign('HMAC', key, enc);
        return btoa(Array.from(new Uint8Array(sig), b => String.fromCharCode(b)).join(''));
      }

      document.getElementById('test').onclick = async () => {
        const {webhook, secret} = await chrome.storage.sync.get(['webhook','secret']);
        if (!webhook || !secret) return alert('Set webhook and secret first');
        const body = { rows: [{ platform:'SelfTest', type:'Ping', title:'Options Test', url:location.href, id:'options', notes:'ok' }] };
        body.sig = await sign(body, secret);
        const res = await fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        alert(res.ok ? 'Test sent' : 'Test failed');
      };
    </script>
  </body>
</html>
